# Physics and Astronomy Exam assessment code# Takes in exam grids (csv files) and produces output exam grids, with averages etc.# # This script requires Pandas with xlswriter (default writer for pandas, as long as v>0.16)## Checked:#    BSc Physics: year marks (std and C19), overall marks#    MPhys Physics: year marks (std and C19), overall marks#    BSc M+P#    MPhys M+P## Not handling Y3 MPhys progression - progress string not used### HISTORY## 12-May-2021  C. Dickinson   Started with updated PyAssessV5.py from Rob Appelby# Specific changes made for AY 2020/2021 (not including tidying up/reformatting etc.)## 1. 13-May-2021: Changed borderlines for 2021 regs (2,2,3) rather than (3,3,4) below borders# 2. 13-May-2021: Removed output Maths only columns for non-M+P students# 3. 13-May-2021: Added deg class string for outputing to final grid (rather than a single number)# 4. 14-May-2021: Changed credit weighting for PHYS20811 # 5. 17-May-2021: Added projectmark calculation for alg B promotion #                 Added P(A) or P(B) string to deg class if promoted (keeping original class for grid)# 6. 18-May-2021: Correct a few bugs in the projectmark calculation (used for alg B promotion ony)#                 Added creditstogetMPHYSalgA for alg A in 4th year#                 Added creditstogetalgB for alg B  #                 Removed algA/B columns because it is now stated in deg classification# 7. 21-May-2021  class=4=32 non-M+P done and checked# 8. 03-Jun-2021  Removed first column index from output Excel files#                 Removed remaining ND variables#                 Put back mathunit=1 for Maths mark!# 9. 04-Jun-2021  Added O/M/P strings for M+P students#                 Fixed Year3 Mark for 4th year M+P students#10. 10-Jun-2021  Fixed reading in of X, XL codes etc due to stripping of columns with no header (commented out)#11. 14-Jun-2021  Tidying up, removing giverealcredits, adjusting output filenames#12. 15-Jun-2021  Added column width adjustments for output Excel spreadsheet#13. 16-Jun-2021  Bug fixes for classyear=31 and output changes#                 Changed 3-4 progression credits >80 (rather than 2/3 of taken)#14. 17-Jun-2021  Added back PHYS30811 into credit weights for mean mark for resitting students#                 Included progression for years 1 and 2 including MPhys and Study in Europe (***STILL NEED S1 MARK THOUGH)##################################################################### imports#from typing import Anyimport pandas as pdimport numpy as npimport sys#import matplotlib.pyplot as plt#from scipy.stats import linregress#import itertools#from decimal import Decimalpd.options.mode.chained_assignment = None  # default='warn'# used for skipping first few rows of CS grid (note system dependent)def rowskiplogic(index):    if index==0 or index==1 or index==2 or index==3:       return True    return Falsedef rowskiplogiccourse(index):    if index==0 or index==1 or index==2 or index==3:       return True    return False# convert degree class to a string for output griddef degclass_to_string(progtaken,degclass):    # deg classification    degclass_dict = {        4:"1",        3:"2:1",        2:"2:2",        1:"3",        0:"Ord.",        -1:"Fail",        -2:"NOT SET!!!"}    # degree type    degstr = progtaken.split('(')[0] + ' '                return degstr + degclass_dict[degclass]    ################################################################# INPUTS################################################################# Switch between BSc (classyear=3) and MPhys (classyear=4)# 1=1st year, 2=2nd year, 31=3rd prog, 32=3rd complete ,4=4th year########classyear=2# 1=physics, 2=MPstudtype=1########## program locationexcelDir='./'# Input and output filesif(classyear==1):    #excelFilename = '/data1920_AY2021/1styr_07_07_20 postmcc.csv'    #excelFilename = '/newyears12_250820/1styr_19.08.20.csv'    #excelFilename = '../PyAssess_OLD/newyears12_250820/1styr_19.08.20.csv'    excelFilename = './ExampleGrids_11-06-2021/1st year exam grid_10.06.21.csv'    # output filename    if (studtype==1): outfilename = '1styear_Physics.AY2021.prelimfinal.xlsx'   # Physics filename    else: outfilename = '1styear_MathsPhysics.AY2021.prelimfinal.xlsx'   # M+P filename        # if we have carry forward we can compute degree class, so turn this on    deganalysis = 0    # perform borderline checks, yes/no    doingborderline = 0if (classyear == 2):    # excelFilename = '/data1920/4thyr test grid_16.06.20.csv'    #excelFilename = '/newyears12_250820/2ndyr_19.08.20.csv'    excelFilename = './ExampleGrids_11-06-2021/2nd year exam grid_10.06.21.csv'    # output filename    if (studtype==1): outfilename = '2ndyear_Physics.AY2021.prelimfinal.xlsx'   # Physics filename    else: outfilename = '2ndyear_MathsPhysics.AY2021.prelimfinal.xlsx'   # M+P filename        # if we have carry forward we can compute degree class, so turn this off as its second year    deganalysis = 0    # perform borderline checks, yes/no    doingborderline = 0if(classyear==32):    #excelFilename='/data1920/3rdyr BSc Physics 80 credits v2 with external.csv'    #excelFilename = '/data1819/3rdyr_18_06_19_external.csv'    excelFilename = './ExampleGrids_11-06-2021/3rd year exam grid_10.06.21.csv'    #CFfilename = '/Carryforward/3rdyr_carryforward.csv'    CFfilename = './ExampleGrids_11-06-2021/3rd year carry forward.csv'    # output filename    if (studtype==1): outfilename = 'FinalYear_BSc_Physics.AY2021.prelimfinal.xlsx'   # Physics filename    else: outfilename = 'FinalYear_BSc_MathsPhysics.AY2021.prelimfinal.xlsx'   # M+P filename        # if we have carry forward we can compute degree class, so turn this on    deganalysis = 1    # perform borderline checks, yes/no    doingborderline = 1if (classyear == 31):    #excelFilename = '/data1920_AY2021/3rdyr_07_07_20 MPhys postmcc_updated.csv'    #excelFilename = '/data1819/3rdyr_18_06_19_external.csv'    excelFilename = './ExampleGrids_11-06-2021/3rd year exam grid_10.06.21.csv'        #CFfilename = '/Carryforward/3rdyr_carryforward.csv'    CFfilename = './ExampleGrids_11-06-2021/3rd year carry forward.csv'    # output filename    if (studtype==1): outfilename = '3rdyear_MPhys.AY2021.prelimfinal.xlsx'   # Physics filename    else: outfilename = '3rdyear_MMath.AY2021.prelimfinal.xlsx'   # M+P filename        # if we have carry forward we can compute degree class, so turn this on    deganalysis = 0    # perform borderline checks, yes/no    doingborderline = 0if(classyear==4):    #excelFilename = '/data1819/4thyr_18_06_19_external.csv'    excelFilename = './ExampleGrids_11-06-2021/4th year exam grid_10.06.21.csv'        #CFfilename='/Carryforward/4thyr_carryforward.csv'    CFfilename = './ExampleGrids_11-06-2021/4th year carry forward.csv'    # output filename    if (studtype==1): outfilename = 'FinalYear_MPhys.AY2021.prelimfinal.xlsx'   # Physics filename    else: outfilename = 'FinalYear_MMath.AY2021.prelimfinal.xlsx'   # M+P filename        # if we have carry forward we can compute degree class, so turn this on    deganalysis = 1    # perform borderline checks, yes/no    doingborderline = 1# final filenamefilename=excelDir+excelFilename# Credits requiredcreditstogetMPHYS = 80  creditstogetBScgood=80creditstogetBSclower=60creditstogetMPHYSalgA = 75 # Used for algA creditstogetalgB = 70  # Used for algB# testing only for 2018/19 data! ***REMOVE/COMMENT OUT!!!#creditstogetMPHYS = 80  #creditstogetBScgood=80#creditstogetBSclower=60#creditstogetMPHYSalgA = 80 # Used for algA #creditstogetalgB = 70  # Used for algB# boundaries for degree class (2 d.ps because marks are stored to 1 d.p.)boundaryfirst=69.95boundaryupper2=59.95boundarylower2=49.95boundarythird=39.95# borderlines for promotion consideration (changed for AY2020/2021)borderfirst = 68.borderupper2 = 58.borderlower2 = 48.borderthird = 37.# borderlines for promotion consideration (for 2018/19 testing only). ***REMOVE/COMMENT OUT!!!#borderfirst = 67.#borderupper2 = 57.#borderlower2 = 47.#borderthird = 36.# any students to skipdonotprocess={'10304702'}   # IDs should be strings! For 2021 to omit just one student (see Suzanne's email 11-Jun-2021) ################################################################# some data definitions################################################################# define core for purposes of triggering resitsiscore={'PHYS10071','PHYS10101','PHYS10121','PHYS10191','PHYS10302','PHYS10342','PHYS10352','PHYS10372','PHYS20101','PHYS20141','PHYS20161','PHYS20171','PHYS20252','PHYS20312','PHYS20352'}#define what must be passed e.g. lab, BSc dissertation.mustpass={'PHYS10180','PHYS10280',          'PHYS20180','PHYS20280',          'PHYS30180','PHYS30280','PHYS30880',          'PHYS40181','PHYS40182'}# these are where units may have different credits for the marks vs progression credweightunits={'PHYS20040':10,  # main general paper (doesn't count towards progression/resits, but does count towards marks)'PHYS20240':6,            # shorter version worth only 6 (M+P,Phys/Phil, 2nd/3rd year direct entry) 'PHYS20811':5,            # Professional development CD: changed from 9 to 5 in AY2021'PHYS30010':10,           # General paper (doesn't count towards progression/resits, but does count towards marks)'PHYS30210':6.,           # General paper (short version for M+P, Phys/Phil, 2nd/3rd year direct entry)'PHYS30811':3             # Added back for those few students re-sitting}#'PHYS20030':0,            # Peer-Assisted Study Sessions (PASS) - no marks, no credits, but here just in case #'ULGE21030':0,            # #'ULFR21030':0,#'ULJA21020':0,#'ULRU11010':0,#'MATH35012':0,#'COMP39112':0,#'MATH49102':0}noresitlist={ 'PHYS20252', 'PHYS20312', 'PHYS20352','PHYS20811'}# BELOW IS JUST FOR TESTING WITH 2018/19 DATA!! ***REMOVE/COMMENT OUT!!!#credweightunits={'PHYS20040':10,#'PHYS20240':6,#'PHYS20811':9,#'PHYS20821':5,#'PHYS30010':10,#'PHYS30210':6,#'PHYS30811':3,#'PHYS20030':0,#'ULGE21030':0,#'ULFR21030':0,#'ULJA21020':0,#'ULRU11010':0,#'MATH35012':0,#'COMP39112':0,#'MATH49102':0#}    ################################################################################################################################################################################################# the key function. Reads the grid and returns analysis of the target student.def analysisstudentfinalyear(filename,targetstudent):    #print("Analysing new student",targetstudent)    # read data with row 4 (starting from 0) as hesders to get right data    try:        df=pd.read_csv(filename,skiprows= lambda x: +rowskiplogiccourse(x),dtype='str',encoding = "ISO-8859-1")    except:        print('\nERROR reading main input file. Please check filename and/or directory...\n')        sys.exit(1)            #df = df.loc[:, ~df.columns.str.contains('^Unnamed')] # do not do this as there are extra columns for X, XL codes etc.        # remove bad characters    df = df.replace(np.nan, '', regex=True)    headers=list(df.columns.values)    dfheaders = pd.DataFrame(columns=headers)    #print(headers)        # useful : df.loc[(df[‘Color’] == ‘Green’) & (df[‘Shape’] == ‘Rectangle’)]    # select row with studentID= target    selected=df.loc[df['Emplid'] == targetstudent]    #print(selected)    # get index number of this ropw    selectedindex=selected.index    #print(targetstudent,selectedindex)    #print('target student',targetstudent)    # extract course names (top row of target student in grid)    studata=(df.iloc[selectedindex])    # extract course marks (bottom row of target student in grid)    stumarks=(df.iloc[selectedindex+1])    #print(studata)    #print(stumarks)    # make studata into series    studata=studata.iloc[0]    # get prog    progtaken=studata[4]    #print("setting prog taken",progtaken)    stumarks=stumarks.iloc[0]    # define a lot of variables for a given student. We return most of these    markspresent=0    creditstaken=0    creditspassed=0    creditspassedlab=0    creditsov30=0        mean=0    meancredsum=0    creditsformeansum=0    credsatfirst=0    credsatupper2 = 0    credsatlower2 = 0# resit variables    someunitunder30=0    referredcore=' '    referredoption = ' '    deferredcore = ' '    deferredoption=' '    credittarget=120.    creditsexcluded=0    honours=0    degclass=-1    faillabprog=0    projectmark=-1.    project1mark=-1  # project mark for S1    project1cred=-1  # credit for project S1    project2mark=-1  # project mark for S2    project2cred=-1  # credit for project S2    mathunit=0        included=[]    coursesincludedcompletestring=' '    excluded=' '    mathscreditstaken = 0.    mathscreditsmeansum = 0.    mathscreditspassed=0.    # maths sums. only relevant for maths/phys students.    if('Math' in progtaken):        mathsphys=1    else:        mathsphys = 0    # mathsphys=0 for physics student, =1 for maths/physics student    stuname =studata[1]    #print("Name ",stuname)    # loop over student courses    for i in range(studata.size):        #print(studata[0],studata[i], stumarks[i])        # spot a valid course. (An upgrade would do this automatically)        if( (('PHYS' in studata[i] or'EART'in studata[i] or 'HSTM'in studata[i]  or 'UCOL'in studata[i] or 'MATH'in studata[i]            or 'BIOL'in studata[i] or 'PHIL'in studata[i] or 'UCIL'in studata[i] or 'ECON' in studata[i]                     or 'COMP' in studata[i] or 'BMAN' in studata[i] or 'HSTM' in studata[i] or 'MCEL' in studata[i] or 'MACE' in studata[i]            or 'ULBS' in studata[i] or 'ULCH' in studata[i] or 'ULIT' in studata[i] or 'ULPT' in studata[i]            or 'ULGE' in studata[i] or 'ULFR' in studata[i] or 'ULJA' in studata[i] or 'ULSP' in studata[i]             or   'ULAR' in studata[i] or 'ULBS' in studata[i] or 'ULCH' in studata[i] or 'ULDU' in studata[i] or 'ULFR' in studata[i]                or 'ULGE' in studata[i] or 'ULHB' in studata[i] or 'ULIT' in studata[i] or 'ULKR' in studata[i] or 'ULJA' in studata[i]                or 'ULPE' in studata[i] or 'ULPT' in studata[i] or 'ULRU' in studata[i] or 'ULSP' in studata[i] or 'ULTU' in studata[i]                or 'ULUR' in studata[i] or 'MUSC' in studata[i]))            ):                        # reject 'MPHYS' column as it's not a course!            if(studata[i]=='MPHYS' or studata[i]=='MPHYSHON'): continue            # get course name            coursename = studata[i][0:9]            #print('found course:',coursename)            #print(stumarks)                        # reset variables.            # exclude is MC exclusion.            excludethiscourse = 0            mainmarkfound = 0            profoundinsub=0            markcomponentsfound=0            mathunit = 0            thiscredit=0.            deferethiscourse=0            # if a mark ends R, remove R and use the mark (ignoring sub-marks)            if('R' in stumarks[i] and (not stumarks[i]=='PRO')):                #print("Found R mark")                stumarks[i]=stumarks[i][:2]                #print(stumarks[i])            if ('C' in stumarks[i] and (not stumarks[i] == 'PRO')):                #print("Found compensated mark ", stumarks[i])                stumarks[i] = stumarks[i][:2]                #print(stumarks[i])            # If no mark, ignore, and just continue to next one            if (stumarks[i] == ''):                print("WARNING: no mark "+stuname)                continue            #print('main mark found', float(stumarks[i]))            thismark = float(stumarks[i])            # get credits            # must be a straightforward mark or a progression            # dig out credits taken            lbindex = studata[i].find('(')            rbindex = studata[i].find(')')            # print(lbindex, rbindex)            # print(studata[i][lbindex+1:rbindex])            thiscredits = float(studata[i][lbindex + 1:rbindex])            #print('using main mark credits ',thiscredits)            #print(targetstudent,studata[i][0:9],stumarks[i],stumarks[i+1],thiscredits)            # credits for this course            creditsformean = thiscredits            #print('creditsformean ',creditsformean)            # if zero credits, may need credits for credit weighted mean            if (creditsformean == 0):                 creditsformean = credweightunits[coursename]            # print('Using ',creditsformean, ' credits for ',coursename)            # panic            if (creditsformean == 0):                print('***WARNING: I do not know the credit weight for the mean of ', coursename)            # include credits for vacation essay if S2 exams excluded            # give vacation essay credits as real credits if giverealcredits=1            #if (coursename == "PHYS30811"):            #    thiscredits = creditsformean            #    studata[i] = 'PHYS30811 (3)'            #if (coursename == "PHYS20821"):            #    thiscredits = creditsformean            #    studata[i] = 'PHYS20821 (5)'                        ######## exclusion            if (stumarks[i + 1] == 'X'):                #print("exclude!")                excludethiscourse = 1                creditsexcluded+=creditsformean                excluded = excluded + coursename + ' '                stumarks[i]=stumarks[i]+'X'            if (stumarks[i ] == '40X'):                  #print("exclude!")                excludethiscourse = 1                creditsexcluded+=creditsformean                excluded = excluded + coursename + ' '                stumarks[i]=stumarks[i]+'X'            if (stumarks[i + 1] == 'XL'):                #print("missed with a reason. exclude!")                excludethiscourse = 1                creditsexcluded += creditsformean                excluded = excluded + coursename + ' '                stumarks[i] = stumarks[i] + 'XL'                            # deferral            if (stumarks[i + 1] == 'X1'):                #print("deferred",coursename)                deferethiscourse = 1            if (stumarks[i + 1] == 'XN'):                #print("missed with no reason. NOT exclude!")                pass  # do nothing            #####################            # if a maths course for recording M+P separately (for M+P students)            if ('MATH' in studata[i]):  mathunit = 1            	    # log the credits taken by the student, first for physics, then maths (if maths/phys)            creditstaken += thiscredits            if (mathunit == 1):                mathscreditstaken += thiscredits                #print("maths credits added ", mathscreditstaken, thiscredits)            if (not excludethiscourse): creditsformeansum += creditsformean            markspresent+=1	    # update meancredsum (used for mean)            if(not excludethiscourse):                meancredsum+=thismark*creditsformean                               if(mathunit==1):                    #print('######', thismark, creditsformean)                    mathscreditsmeansum+=thismark*creditsformean            # log credits above 40% and 30%            if thismark >= 40.:                creditspassed += thiscredits                #print("Credits passed ",coursename,thiscredits,creditspassed)                if(coursename in mustpass):                    creditspassedlab+=thiscredits                if(mathunit):                    #print('logging maths credits passed',coursename,thismark,thiscredits)                    mathscreditspassed+=thiscredits            if thismark >= 30.: creditsov30 += thiscredits            # has this course been failed when it must be passed i.e. lab,  project?            if (coursename in mustpass and thismark<40.): faillabprog = 1            # if any course is < 30%, resits triggered for 2nd year (also trigger resits in main program once have all unit data            if(thismark<30 and not coursename in noresitlist): someunitunder30=1            # in case resits get triggered, log what would be referred.            if(thismark<40 and coursename in iscore and thiscredits>0):               if(not coursename in noresitlist):                    if (not deferethiscourse):                        referredcore = referredcore + coursename + ' '                    else:                        deferredcore =deferredcore + coursename + ' '            if (thismark < 30 and coursename not in iscore and thiscredits>0):                if (not coursename in noresitlist):                    if (not deferethiscourse):                        referredoption = referredoption + coursename + ' '                    else:                        deferredoption= deferredoption + coursename + ' '            # get project mark for the grid display and for future calls (e.g. algB).            # taking into account special cases for non-standard projects (Phys/Phil and M+P)            # or with only 1 project            if coursename == 'PHYS30880':                projectmark=thismark   # BSc dissertation                #print('Project mark is ',thismark)                            if (coursename=='PHYS40181' and project1mark == -1):                project1mark=thismark  # S1                project1cred=thiscredits            elif (coursename=='PHYS40181' and project1mark >= 0):                project2mark=thismark # in case S1 is a different module (see below)                project2cred=thiscredits                            if (coursename=='PHYS40182' and project2mark == -1):                project2mark=thismark  # S2                project2cred=thiscredits            elif (coursename=='PHYS40182' and project2mark >= 0):                project1mark=thismark  # in case S2 is a different module (see below)                project1cred=thismark                              # for Phys/Phil who do an essay for one project - only worth 10 credits c.f. 20 credits for physics            if (coursename=='PHIL40000' and project1mark==-1):                project1mark=thismark                project1cred=thiscredits            elif (coursename=='PHIL40000' and project2mark==-1):                project2mark=thismark                project2cred=thiscredits                            # for Maths/Phys Maths projects only 15 credits c.f. 20 credits for physics            if (coursename=='MATH40011' and project1mark==-1):                project1mark=thismark                project1cred=thiscredits            if (coursename=='MATH40022' and project2mark==-1):                project2mark=thismark                project2cred=thiscredits                            # log credits at boundaries            if thismark >= 70.:                credsatfirst+=thiscredits            if thismark >= 60.:                credsatupper2 += thiscredits            if thismark >= 50.:                credsatlower2 += thiscredits    # combine S1/S2 project marks after all courses when they are set    if (projectmark==-1 and project1mark >= 0 and project2mark >= 0): projectmark = ((project1mark*project1cred)+(project2mark*project2cred))/(project1cred+project2cred)    elif (projectmark==-1 and project1mark >= 0 and project2mark < 0): projectmark = project1mark  # if only 1 project mark    elif (projectmark==-1 and project1mark < 0 and project2mark >= 0): projectmark = project2mark  # if only 1 project mark            # compute mean credit sum    if(creditsformeansum>0):        meancredsum=meancredsum/creditsformeansum    else:        meancredsum=0    if(mathscreditstaken>0.):        #print('maths mark calc:',mathscreditsmeansum,mathscreditstaken)        mathscreditsmeansum=mathscreditsmeansum/mathscreditstaken    else:        mathscreditsmeansum=0    dfheaders=dfheaders.append(studata)    dfheaders = dfheaders.append(stumarks)    # log data we have made in new columns in data frame    dfheaders['Credits Taken']=creditstaken    dfheaders['Credits Passed'] = creditspassed    dfheaders['Project Mark']= round(projectmark+0.0000001,1)  # to 1.d.p.    dfheaders['Credits Excluded'] = creditsexcluded    dfheaders['Courses Included']=coursesincludedcompletestring    dfheaders['Courses Excluded'] = excluded    #print('@@@@@@@@@@@@@@', meancredsum, creditsformeansum)        #print('end of student routine')    return progtaken,mathsphys,meancredsum,mathscreditsmeansum,creditstaken,mathscreditstaken,creditspassed, mathscreditspassed,creditspassedlab,faillabprog, projectmark, excluded, creditsexcluded,credsatfirst, credsatupper2, credsatlower2, someunitunder30, referredcore,referredoption,deferredcore,deferredoption,dfheaders################################## extracts carry forward for target studendef getCF3rdYear(filename,targetstudent):    yearmark3=-1. # for 4th year maths/phys students    # get CF marks    #print("doing CF",targetstudent, filename)    try:        df = pd.read_csv(filename, skiprows=lambda x: +rowskiplogic(x), dtype='str', engine='python')    except:        print('\nERROR reading Carry Forward file. Please check filename and/or directory...\n')        sys.exit(1)    df = df.replace(np.nan, '', regex=True)    #print(df.head(20))    #print('target student=',targetstudent)    selected = df.loc[df['Emplid'] == targetstudent]    #print("selected data")    #print(selected)    headers = list(df.columns.values)    dfheaders = pd.DataFrame(columns=headers)    #print(headers)    # get index number of this ropw    selectedindex = selected.index    #print("reached here")    #print(selected.index)    data=(df.iloc[selectedindex])    #print("printing data")    #print(data)    data=data.iloc[0]    #print(data[3])    nofirstyear=0    #print(data[3])    if data[3]=='n/a' or data[3]=='':        data[3]='-1'    if data[4] == 'n/a' or data[4]=='':        data[4] ='-1'    if data[5] == 'n/a' or data[5] == '':        data[5] = '-1'    if data[6]=='n/a' or data[6]=='':        data[6]='-1'    if data[7] == 'n/a' or data[7]=='':        data[7] ='-1'    if data[8] == 'n/a' or data[8] == '':        data[8] = '-1'    #if(classyear==4):        #if data[9] == 'n/a' or data[9] == '':            #data[9] = '-1'    #print(data[3],data[4])    #print('HERE')    phys1=float(data[3])    phys2=float(data[4])    phys3 = float(data[5])    maths1=float(data[6])    maths2=float(data[7])    maths3 = float(data[8])    # get Year 3 mark for 4th year M+P students    if (classyear == 4 and studtype == 2):        yearmark3=float(data[9])        #yearmark3 = (phys3+maths3)/2 # incorrect - not a straight average. This is just in case year3mark not available in CF file    #print('CF : ',phys1,phys2,phys3,maths1,maths2,maths3,yearmark3)    return phys1,phys2,phys3,maths1,maths2,maths3,yearmark3################################# combine year marks to overall mark.def getoverallmark(maths1,maths2,maths3,yearmark3,phys1, phys2,phys3,finalyearmark,finalyearmathsmark,finalyearphysicsmark,progtaken,force3yr):    overallmark=-1.    overallmathsmark=-1.    overallphysicsmark=-1.    # BSc    if( ( ('BSc' in progtaken) or force3yr==1) and not('Math' in progtaken)):        overallmark= 0.1*phys1+0.3*phys2+0.6*finalyearmark        if(phys1<0 and phys2>0): overallmark=0.333*phys2+0.666*finalyearmark # no first year mark, so direct entry        if(phys1<0 and phys2<0): overallmark = finalyearmark  # no first or second year mark, so direct entry        overallphysicsmark = overallmark    # BSc M/P    if( ( ('BSc' in progtaken) or force3yr==1) and 'Math' in progtaken):                 overallmark= 0.1*(phys1+maths1)/2.+0.3*(phys2+maths2)/2.+0.6*finalyearmark                         if(phys1<0 and phys2>0): overallmark=0.333*(phys2+maths2)/2.+0.666*finalyearmark # no first year mark, so direct entry                      overallphysicsmark = 0.1 * (phys1) + 0.3 * (phys2) + 0.6 * finalyearphysicsmark         if (phys1 < 0 and phys2 > 0): overallphysicsmark = 0.333 * phys2 + 0.666 * finalyearphysicsmark  # no first year mark, so direct entry         overallmathsmark = 0.1 * (maths1) + 0.3 * (maths2) + 0.6 * finalyearmathsmark         if (phys1 < 0 and phys2 > 0): overallmathssmark = 0.333 * maths2 + 0.666 * finalyearmathsmark  # no first year mark, so direct entry         #print("computed BSc Maths overall mark ",phys1,phys2,finalyearphysicsmark,finalyearmathsmark,maths1,maths2,finalyearmark,overallphysicsmark,overallmathsmark,overallmark)         #if(phys1<0 and phys2<0): overallmark = finalyearmark  # no first or second year mark, so direct entry. This should not happen    #  MPHYS    if ('MPhys' in progtaken and not('Math' in progtaken) and not force3yr):        #print('MPHYS, not Maths')        overallmark = 0.06 * phys1 + 0.19 * phys2 + 0.375 * phys3 + 0.375*finalyearmark                 if (phys1 < 0 and phys2 > 0): overallmark = 0.2*phys2+ 0.4*phys3 + 0.4*finalyearmark  # no first  year mark, so direct entry        if (phys1 < 0 and phys2 < 0): overallmark = 0.5*phys3 + 0.5*finalyearmark  # no first or second year mark, so direct entry        overallphysicsmark = overallmark    # MPHYS study in    if ( ('MPhys' in progtaken and not('Math' in progtaken) and 'Study' in progtaken)  and not force3yr):        #print('MPHYS, study in')        overallmark = 0.08 * phys1 + 0.23 * phys2 + 0.23 * phys3 + 0.46*finalyearmark        # There are no Phys Europe 4th years this year.        # The problem is that the 4th years who were abroad last year are on the same programmes as the other students        # so there is nothing to differentiate them. I used to add a code to Peter’s        # program to flag this – [3A] at the end of the programme code on the input grid and discussed doing something similar this year with Rob.    if ('3A' in progtaken and not force3yr):        #print("making a 3A deg calc")        overallmark = 0.08 * phys1 + 0.23 * phys2 + 0.23 * phys3 + 0.46 * finalyearmark    # MPHYS M/P.    if ('Phys' in progtaken and 'Math' in progtaken and not force3yr and not ('BSc' in progtaken)):        #print('MPHYS,  Maths')        overallmark = 0.06 * (phys1+maths1)/2. + 0.19 * (phys2+maths2)/2. + 0.375 * yearmark3 + 0.375*finalyearmark                overallmathsmark =  0.06 * maths1 + 0.19 * maths2 + 0.375 * maths3 + 0.375*finalyearmathsmark                overallphysicsmark = 0.06 * phys1 + 0.19 * phys2 + 0.375 * phys3 + 0.375*finalyearphysicsmark                if (phys1 < 0 and phys2 > 0):                         overallmark = 0.2*(phys2+maths2)/2.+ 0.4*yearmark3 + 0.4*finalyearmark  # no first  year mark, so direct entry                       overallmathsmark = 0.2*maths2 + 0.4*maths3 + 0.4*finalyearmathsmark  # no first  year mark, so direct entry             overallphysicsmark = 0.2*phys2+ 0.4*phys3 + 0.4*finalyearphysicsmark  # no first  year mark, so direct entry        if (phys1 < 0 and phys2 < 0):                         overallmark = 0.5*yearmark3 + 0.5*finalyearmark  # no first or second year mark, so direct entry                           overallphysicsmark = 0.5*phys3 + 0.5*finalyearphysicsmark  # no first or second year mark, so direct entry                                       overallmathsmark = 0.5*maths3 + 0.5*finalyearmathsmark  # no first or second year mark, so direct entry          #print('returning OM,OMM,OPM',overallmark, overallmathsmark, overallphysicsmark, progtaken)    return overallmark, overallmathsmark, overallphysicsmark################################# figures out overall degree class based on overall mark and credits passeddef getMPhysDegClass(overallmark, creditspassed):    # first    if  creditspassed>=creditstogetMPHYS and overallmark>=boundaryfirst:        honours=1        degclass=4    # 2:1    elif creditspassed>=creditstogetMPHYS and overallmark>=boundaryupper2 and overallmark<boundaryfirst:        honours = 1        degclass = 3    # 2:2    elif creditspassed>=creditstogetMPHYS and  overallmark>=boundarylower2 and overallmark<boundaryupper2:        honours = 1        degclass = 2    # no thirds in MPHYS    # fail    else:        honours=0        degclass=-1    #eligible for BSc on marks in first three years, return -1 in degclass to note this    return honours, degclass################### BSc class (a touch more complex than MPHYS class)def getBScDegClass(overallmark, creditspassed):    if  creditspassed>=creditstogetBScgood and overallmark>=boundaryfirst:        honours=1        degclass=4    elif creditspassed >= creditstogetBSclower and creditspassed <=creditstogetBScgood and overallmark >= boundaryfirst:        honours = 1        degclass = 3    elif creditspassed>=creditstogetBScgood and overallmark>=boundaryupper2 and overallmark<boundaryfirst:        honours = 1        degclass = 3    elif creditspassed>=creditstogetBSclower and creditspassed <=creditstogetBScgood and overallmark>=boundaryupper2 and overallmark<boundaryfirst:        honours = 1        degclass = 2    elif creditspassed>=creditstogetBScgood and  overallmark>=boundarylower2 and overallmark<boundaryupper2:        honours = 1        degclass = 2    elif creditspassed>=creditstogetBSclower and  creditspassed<creditstogetBScgood and overallmark>=boundarylower2 and overallmark<boundaryupper2:        honours = 1        degclass = 1    elif creditspassed >= creditstogetBSclower and overallmark >= boundarythird:        honours = 1        degclass = 1    elif creditspassed >= creditstogetBSclower:        honours =0        degclass=0    else:        honours=0        degclass=-1    return honours, degclass################### promote by Alg A? 1 or 0 (A = Stage 1 - by mark distribution - see section 12.5 of UG handbook)def algorithmA(progtaken,degclass,credsatfirst,credsatupper2,credsatlower2):    promote=0        if('BSc' in progtaken):        if(degclass==3 and credsatfirst>=creditstogetBScgood):            promote=1        if(degclass==2 and credsatupper2>=creditstogetBScgood):            promote=1        if(degclass==1 and credsatlower2>=creditstogetBScgood):            promote=1    else:        if (degclass == 3 and credsatfirst >= creditstogetMPHYSalgA):            promote = 1        if (degclass == 2 and credsatupper2 >= creditstogetMPHYSalgA):            promote = 1        if (degclass == 1 and credsatlower2 >= creditstogetMPHYSalgA):            promote = 1                #print("alg A ",promote,degclass,credsatfirst,credsatupper2,credsatlower2,creditstogetBScgood,creditstogetMPHYS)    return promote################### promote by alg B. yes/no (B = Stage 2  - criteria-based classification review - see section 12.5 of UG handbook)def algorithmB(progtaken,degclass,credsatfirst,credsatupper2,credsatlower2,finalyearmark,overallmark,projectmark):    promote=0    if('BSc' in progtaken):        if(degclass==3 and credsatfirst >= creditstogetalgB and projectmark>=boundaryfirst and finalyearmark>overallmark):            promote=1        if(degclass==2 and credsatupper2 >= creditstogetalgB and projectmark>=boundaryupper2 and finalyearmark>overallmark):            promote=1        if(degclass==1 and credsatlower2 >= creditstogetalgB and projectmark>=boundarylower2 and finalyearmark>overallmark):            promote=1    else:        if (degclass == 3 and credsatfirst >= creditstogetalgB and projectmark >=boundaryfirst and finalyearmark > overallmark):            promote = 1        if (degclass == 2 and credsatupper2 >= creditstogetalgB and projectmark >=boundaryupper2 and finalyearmark > overallmark):            promote = 1        if (degclass == 1 and credsatlower2 >= creditstogetalgB and projectmark >=boundarylower2 and finalyearmark > overallmark):            promote = 1    return promote############################################################################################################################################################################################# NOW THE RUNNING PART OF THE CODE############################################################################################################################################################################################# open file and clean filetry:    df = pd.read_csv(filename, skiprows=lambda x: +rowskiplogic(x), dtype='str',encoding = "ISO-8859-1")except:    print('\nERROR reading the main input file. Please check filename and/or directory...\n')    sys.exit(1)    df = df.loc[:, ~df.columns.str.contains('^Unnamed')]   df = df.replace(np.nan, '', regex=True)# Get all# select just IDs easily without a loop#sidsname=list(df.columns)[0]# get IDs. select column of IDs and then every other one using ::2#sids=(df.loc[:,sidsname])[::2]if(classyear==1):    #print('taking all students in year 1')    #df=df[(df['Plan'].str.contains('MPhys')) | (df['Plan'].str.contains('BSc'))]    #df=df[(df['Plan'].str.contains('MPhys')) & (~df['Plan'].str.contains('Math'))]    # take all    #df = df[(df['Plan'].str.contains('MPhys')) | (df['Plan'].str.contains('BSc')) | (df['Plan'].str.contains('Math'))]    if (studtype == 1):        df = df[(df['Plan'].str.contains('MPhys')) | (df['Plan'].str.contains('BSc')) & (~df['Plan'].str.contains('Math'))]    else:        df = df[(df['Plan'].str.contains('Math'))]if(classyear==2):    if (studtype == 1):        df = df[(df['Plan'].str.contains('MPhys')) | (df['Plan'].str.contains('BSc')) & (~df['Plan'].str.contains('Math'))]    else:        df = df[(df['Plan'].str.contains('Math'))]if(classyear==31):# df=df[(df['Plan'].str.contains('MPhys')) | (df['Plan'].str.contains('Math'))]    if (studtype == 1):        df = df[(df['Plan'].str.contains('MPhys'))]    else:        df = df[(df['Plan'].str.contains('MMath'))]#  Select BScs without mathsif(classyear==32):    if(studtype==1):        df = df[(df['Plan'].str.contains('BSc')) & (df['Plan'].str.contains('Physics'))]    else:        df = df[(df['Plan'].str.contains('BSc')) & (df['Plan'].str.contains('Math'))]# Select MPHYS no mathsif(classyear==4):    #print ('analysing year 4')    if (studtype == 1):        df = df[(df['Plan'].str.contains('MPhys'))]    else:        df = df[(df['Plan'].str.contains('MMath'))]sidsname=list(df.columns)[0]sids=(df.loc[:,sidsname])#print(df)cohortmean=0cohortcount=0cohortcreditpassedmean=0cohortcredittakenmean=0numberfirsts=0numberupper2=0numberlower2=0numberthird=0numberordinary=0numberfail=0numberborderline=0numberPApromote=0numberPBpromote=0degclasschange=0degclasschangeup=0degclasschangedown=0degclass=-1# overall dataframe of all students.try:    dftemp=pd.read_csv(filename,skiprows= lambda x: +rowskiplogic(x),dtype='str',encoding = "ISO-8859-1")except:    print('\nError reading main input file. Please check filename and/or directory...\n')    sys.exit(1)    dftemp = df.loc[:, ~df.columns.str.contains('^Unnamed')]dftemp = dftemp.replace(np.nan, '', regex=True)headers=list(dftemp.columns.values)newheaders=[]for s in headers:    if(not 'Unnamed' in s):        newheaders.append(s)dfallstudents= pd.DataFrame(columns=newheaders)#print('IDs read')#print(sids)# loop over IDsfor anid in sids:        #print('**************')    #print('doing student ID='+anid)# veto some students    #print('***', anid)    if (anid in donotprocess):        print('***Ignoring ', anid)         continue# -2 means not set. -1 is a fail.    degclass=-2    # needed for progression    fail=0    progress=0    resitstriggered=0    # status string for output grid (default is 'ACTV' unless reason not to progress)    status = 'ACTV'        # fail is failed on credits    # faillabprof means failed lab or project    # get carry forward    if(deganalysis or classyear==31):        #print("getting carryforward")        phys1, phys2, phys3,maths1,maths2,maths3,yearmark3  = getCF3rdYear(excelDir+CFfilename, anid)        #print(phys1,phys2,phys3,maths1,maths2,maths3)    # get all final year data for the student    #print('calling stud ana for ',anid)    progtaken, mathsphys,finalyearmark, finalyearmathsmark,creditstaken,mathscreditstaken,creditspassed,mathscreditspassed,creditspassedlab, \    faillabprog, projectmark,excluded, creditsexcluded,credsatfirst, credsatupper2, credsatlower2, \    someunitunder30, referredcore,referredoption,deferredcore,deferredoption,dfthisstudent = analysisstudentfinalyear(filename, anid)    #print('Creds at first ',credsatfirst)    finalyearphysicsmark=-1.        # if a M/P student, get final year physics mark    if(finalyearmathsmark>0 and mathsphys==1):        #print('#############',creditstaken,mathscreditstaken)        finalyearphysicsmark=(finalyearmark*creditstaken-finalyearmathsmark*mathscreditstaken)/(creditstaken-mathscreditstaken)            # final year mark to 1 d.p. (as per the other years) ensuring no rounding to lower integer    finalyearmark = round(finalyearmark + 0.00000001, 1)    finalyearmathsmark = round(finalyearmathsmark + 0.00000001, 1)    finalyearphysicsmark = round(finalyearphysicsmark + 0.00000001, 1)        # Progression for year 1 (BSc and MPhys) and year 2 (BSc only) - MPhys has extra criteria (see below)    if(classyear==1 or classyear==2):        # 2->3 progression rules        # we need a to pass 80 credits, inc lab,        if (someunitunder30==0 and faillabprog==0 and creditspassed>=80):            status = 'ACTV'   # active (progress)            fail = 0            progress=1            resitstriggered=0            referredcore=' '            referredoption=' '        elif (creditspassed<60):  # at least 60 credits passed (>40%) needed for resits             status = 'FAIL' # outright fail            fail=1            progress=0            resitstriggered=0            referredcore=' '            referredoption=' '                else: # trigger resits if >60 credits            status = 'REVW'   # Resits so review            fail = 0            progress=0            resitstriggered=1    # Additional criteria for year 2 progression on 4 yearcourse if not already a fail    if (classyear==2 and ('MPhys' or 'Math' in progtaken) and fail != 0):        if (finalyearmark < 53):            status = 'R/BSc'  # MPhys student not achieved 53%            fail = 1            progress = 0        if (finalyearmark < 55 and finalyearmark >=53):            status = 'R/X'   # borderline 53-55%: possible continuation after review in January, otherwise move to BSc            fail = 0            progress = 1        if ('Europe' in progtaken): # additional requirements for Study in Europe            if (finalyearmark < 60):   # or s3mark < 55):    ***NEEDS S3 MARK!!                status = 'R/BSc'   # Move to BSc                fail = 1                progress = 0            #if (finalyearmark > 58 and (s3mark > finalyearmark >=58): # potential case to be made for borderlines (but student must make it - so leave for now)            #    status = 'R/X'                # Year 3 progression    if(classyear==31):        # 3 to 4 progression        # here we need the overall mark        overallmark, overallmathsmark, overallphysicsmark = getoverallmark(maths1, maths2, maths3, yearmark3, phys1,                                                                           phys2, phys3, finalyearmark,                                                                           finalyearmathsmark, finalyearphysicsmark,                                                                           progtaken,1)        overallmark = round(overallmark + 0.00000001, 1)        overallmathsmark = round(overallmathsmark + 0.00000001, 1)        overallphysicsmark = round(overallphysicsmark + 0.00000001, 1)        # 3->4 progression rules        # we need a to pass >80 credits taken, inc lab,        if(faillabprog==0 and creditspassed>=80 and finalyearmark>=50. and overallmark>=50. ):            status = 'ACTV'            fail = 0            progress=1        else:            #print("year 31 fail.",faillabprog,creditspassed,finalyearmark,phys3)            status = 'FAIL'            fail = 1            progress=0            # ***get BSC. need to code up    # Add status column after applying progression rules    dfthisstudent['Status'] = status                # produce final year O/M/P string as preferred output in spreadsheet    finalyear_omp_str = '{0:.1f} / {1:.1f} / {2:.1f}'.format(round(finalyearmark+0.0000001,1),round(finalyearmathsmark+0.0000001,1),round(finalyearphysicsmark+0.0000001,1))    dfthisstudent['Final Year Mark'] = finalyearmark    dfthisstudent['Final Year Maths Mark'] = finalyearmathsmark    dfthisstudent['Final Year Physics Mark'] = finalyearphysicsmark    dfthisstudent['Final Year O/M/P'] = finalyear_omp_str        if(deganalysis):        overallmark, overallmathsmark, overallphysicsmark = getoverallmark(maths1,maths2,maths3,yearmark3,phys1, phys2, phys3,finalyearmark,finalyearmathsmark,finalyearphysicsmark, progtaken,0)        overallmark = round(overallmark + 0.00000001, 1)        overallmathsmark = round(overallmathsmark + 0.00000001, 1)        overallphysicsmark = round(overallphysicsmark + 0.00000001, 1)        # produce overall O/M/P string as preferred output in spreadsheet        overall_omp_str = '{0:.1f} / {1:.1f} / {2:.1f}'.format(overallmark,overallmathsmark,overallphysicsmark)        dfthisstudent['Overall O/M/P'] = overall_omp_str        #print('Overall O/M/P: ', overall_omp_str)         dfthisstudent['Credits to get BSc/MPhys Good'] = creditstogetBScgood        dfthisstudent['Credits to get BSc Lower'] = creditstogetBSclower        dfthisstudent['Credits at First'] = credsatfirst        dfthisstudent['Credits at Upper 2'] = credsatupper2        dfthisstudent['Credits to Lower 2'] = credsatlower2        dfthisstudent['Phys 1'] = phys1        dfthisstudent['Phys 2'] = phys2        dfthisstudent['Phys 3'] = phys3        dfthisstudent['Maths 1'] = maths1        dfthisstudent['Maths 2'] = maths2        dfthisstudent['Maths 3'] = maths3        dfthisstudent['Year 3 Mark'] = yearmark3    if (deganalysis or classyear==31):        dfthisstudent['Overall Mark'] = overallmark        dfthisstudent['Overall Maths Mark'] = overallmathsmark        dfthisstudent['Overall Physics Mark'] = overallphysicsmark    if(classyear==2):        dfthisstudent['Credits to get BSc/MPhys Good'] = creditstogetBScgood        dfthisstudent['Credits to get BSc Lower'] = creditstogetBSclower        dfthisstudent['Maths Credits Taken'] = mathscreditstaken        dfthisstudent['Maths Credits Passed'] = mathscreditspassed        dfthisstudent['Fail'] = fail        dfthisstudent['Lab/Proj Fail'] = faillabprog        dfthisstudent['Progress'] = progress        dfthisstudent['Resits Triggered'] = resitstriggered        dfthisstudent['Mark Under 30'] = someunitunder30        dfthisstudent['Referrals Core'] = referredcore        dfthisstudent['Referrals Option'] =referredoption        dfthisstudent['Deferrals Core'] = deferredcore        dfthisstudent['Deferrals Option'] = deferredoption            if(classyear==31):        dfthisstudent['Credits to get BSc/MPhys Good'] = creditstogetBScgood        dfthisstudent['Credits to get BSc Lower'] = creditstogetBSclower        dfthisstudent['Phys 1'] = phys1        dfthisstudent['Phys 2'] = phys2        dfthisstudent['Maths 1'] = maths1        dfthisstudent['Maths 2'] = maths2        dfthisstudent['Fail'] = fail        dfthisstudent['Lab/Proj Fail'] = faillabprog        dfthisstudent['Progress'] = progress    if (deganalysis):        # get overall class        if('BSc'in progtaken):            honours, degclass = getBScDegClass(overallmark, creditspassed)        elif('MPhys' or 'Math' in progtaken):            honours, degclass = getMPhysDegClass(overallmark, creditspassed)        else:            print('Error : do not know degree type',anid,progtaken)        # cohort variables.        cohortmean+=overallmark        cohortcreditpassedmean+=creditspassed        cohortcredittakenmean+=creditstaken        cohortcount += 1        #print('degree class for ',anid,degclass)        #print(cohortcount)        #print('first=', numberfirsts, ' 2:1=', numberupper2, ' 2:2=', numberlower2, 'fails=', numberfail, ' Sum all=',            #numberfirsts + numberlower2 + numberupper2+numberfail)        borderline=-1.        algAprom = -1        algBprom = -1        # promotion if on borderline        if(doingborderline):            borderline=0            if( (overallmark >= borderfirst and overallmark <69.95) or (overallmark >= borderupper2 and overallmark <59.95) or (overallmark >= borderlower2 and overallmark <49.95) or (overallmark>=borderthird and overallmark<39.95)):                #print('borderline')                borderline=1                numberborderline+=1                algAprom=0                algBprom=0                #print('###')                #print(progtaken,degclass,credsatfirst,credsatupper2,credsatlower2)                #print(progtaken,degclass, credsatfirst, credsatupper2, credsatlower2,finalyearmark,overallmark,projectmark)                algAprom=algorithmA(progtaken,degclass,credsatfirst,credsatupper2,credsatlower2)                algBprom=algorithmB(progtaken,degclass, credsatfirst, credsatupper2, credsatlower2,finalyearmark,overallmark,projectmark)            if(borderline and (algAprom==1 or algBprom==1)):                # promote by algorithm A or B                #print('promote')                degclass+=1                   if(algAprom==1): numberPApromote+=1                if(algAprom == 0 and algBprom == 1): numberPBpromote += 1  # only promote to B if algA not successful        # get number in each class after promotion        if(degclass==4.): numberfirsts += 1        if (degclass == 3.): numberupper2 += 1        if (degclass == 2.): numberlower2 += 1        if (degclass == 1.): numberthird += 1        if (degclass == 0.): numberordinary += 1        if (degclass==-1.): numberfail+=1        # also convert deg class to a string for output later         if (borderline and (algAprom==1 or algBprom==1)): # **if promoted, keep original (-1) deg class            degclass_str = degclass_to_string(progtaken,degclass-1)        else:  # for everyone else            degclass_str = degclass_to_string(progtaken,degclass)        # Add P(A) or P(B) to deg class string if promoted         if (algAprom == 1):            degclass_str = degclass_str + ' P(A)'        if (algAprom < 1 and algBprom == 1):            degclass_str = degclass_str + ' P(B)'                    # output to students data frame        dfthisstudent['Deg Class ID'] = degclass        dfthisstudent['Deg Class'] = degclass_str        dfthisstudent['Honours'] = honours        dfthisstudent['Borderline'] =borderline        dfthisstudent['Alg A'] = algAprom        dfthisstudent['Alg B'] =algBprom    # append to main dataframe    dfallstudents = dfallstudents.append(dfthisstudent)    if (deganalysis==1):        print(anid,progtaken,creditstaken,creditspassed,phys1,phys2,phys3,finalyearmark,overallmark,degclass_str)        #print(anid,progtaken,creditstaken,creditspassed,creditstogetBScgood,creditstogetBSclower,phys1,phys2,phys3,finalyearmark,overallmark,projectmark,borderline,algAprom,algBprom,degclass)        pass # do nothing        # Put in blanks for alternative rows for easy output laterif(classyear==4 or classyear==32):    for ind in dfallstudents.index:        if(dfallstudents['Emplid'][ind]==''):            dfallstudents["Credits Taken"][ind] = ''            dfallstudents["Credits Passed"][ind] = ''            dfallstudents["Credits to get BSc/MPhys Good"][ind] = ''            dfallstudents["Credits to get BSc Lower"][ind] = ''            dfallstudents["Project Mark"][ind] = ''            dfallstudents["Final Year Mark"][ind] = ''            dfallstudents["Phys 1"][ind] = ''            dfallstudents["Phys 2"][ind] = ''            dfallstudents["Phys 3"][ind] = ''            dfallstudents["Maths 1"][ind] = ''            dfallstudents["Maths 2"][ind] = ''            dfallstudents["Maths 3"][ind] = ''            dfallstudents["Overall Mark"][ind] = ''            dfallstudents["Overall Maths Mark"][ind] = ''            dfallstudents["Overall Physics Mark"][ind] = ''            dfallstudents["Borderline"][ind] = ''            dfallstudents["Alg A"][ind] = ''            dfallstudents["Alg B"][ind] = ''            dfallstudents["Deg Class"][ind] = ''            dfallstudents["Courses Included"][ind] = ''            dfallstudents["Honours"][ind] = ''            dfallstudents["Courses Excluded"][ind] = ''            dfallstudents["Credits Excluded"][ind] = ''            dfallstudents["Final Year Maths Mark"][ind] = ''            dfallstudents["Final Year Physics Mark"][ind] = ''            dfallstudents["Year 3 Mark"][ind] = ''            dfallstudents['Credits at First'] = ''            dfallstudents['Credits at Upper 2'] = ''            dfallstudents['Credits to Lower 2'] = ''            dfallstudents['Status'][ind] = ''            if(classyear==1):    for ind in dfallstudents.index:        if(dfallstudents['Emplid'][ind]==''):            dfallstudents["Credits Taken"][ind] = ''            dfallstudents["Credits Passed"][ind] = ''            dfallstudents["Final Year Mark"][ind] = ''            dfallstudents["Courses Excluded"][ind] = ''            dfallstudents["Courses Included"][ind] = ''            dfallstudents["Credits Excluded"][ind] = ''            dfallstudents["Final Year Maths Mark"][ind] = ''            dfallstudents["Final Year Physics Mark"][ind] = ''            dfallstudents['Status'][ind] = ''if(classyear==2):    for ind in dfallstudents.index:        if(dfallstudents['Plan'][ind]==''):            dfallstudents["Credits Taken"][ind] = ''            dfallstudents["Credits Passed"][ind] = ''            dfallstudents["Credits to get BSc/MPhys Good"][ind] = ''            dfallstudents["Credits to get BSc Lower"][ind] = ''            dfallstudents["Maths Credits Taken"][ind] = ''            dfallstudents["Maths Credits Passed"][ind] = ''            dfallstudents["Final Year Mark"][ind] = ''            dfallstudents["Courses Included"][ind] = ''            dfallstudents["Courses Excluded"][ind] = ''            dfallstudents["Credits Excluded"][ind] = ''            dfallstudents["Final Year Maths Mark"][ind] = ''            dfallstudents["Final Year Physics Mark"][ind] = ''            dfallstudents['Fail'][ind] = ''            dfallstudents['Lab/Proj Fail'][ind] = ''            dfallstudents['Progress'][ind] = ''            dfallstudents['Resits Triggered'][ind] = ''            dfallstudents['Referrals Core'][ind] = ' '            dfallstudents['Referrals Option'][ind] = ''            dfallstudents['Deferrals Core'][ind] = ' '            dfallstudents['Deferrals Option'][ind] = ''            dfallstudents['Mark Under 30'][ind] = ''            dfallstudents['Status'][ind] = ''            if(classyear==31):    for ind in dfallstudents.index:        if(dfallstudents['Emplid'][ind]==''):            dfallstudents['Fail'][ind] = ' '            dfallstudents['Lab/Proj Fail'][ind] = ' '            dfallstudents['Progress'][ind] = ' '            dfallstudents["Credits Taken"][ind] = ''            dfallstudents["Credits Passed"][ind] = ''            dfallstudents['Courses Included'][ind] = ' '            dfallstudents['Courses Excluded'][ind] = ' '            dfallstudents['Final Year Mark'][ind] = ' '            dfallstudents['Final Year Maths Mark'][ind] = ' '            dfallstudents['Final Year Physics Mark'][ind] = ' '            dfallstudents['Overall Mark'][ind] = ' '            dfallstudents["Credits to get BSc/MPhys Good"][ind] = ''            dfallstudents["Credits to get BSc Lower"][ind] = ''            dfallstudents["Phys 1"][ind] = ''            dfallstudents["Phys 2"][ind] = ''            dfallstudents["Maths 1"][ind] = ''            dfallstudents["Maths 2"][ind] = ''            dfallstudents["Overall Maths Mark"][ind] = ''            dfallstudents["Overall Physics Mark"][ind] = ''            dfallstudents["Project Mark"][ind] = ''            dfallstudents["Credits Excluded"][ind] = ''            dfallstudents['Status'][ind] = ''if(studtype==2 and deganalysis==1):    for ind in dfallstudents.index:        if(dfallstudents['Emplid'][ind]==''):            dfallstudents['Final Year O/M/P'][ind] = ' '            dfallstudents['Overall O/M/P'][ind] = ' '            if(deganalysis):    print('')    #print('No exclusions and standard 80/60 rules:')    print('Cohort count = {0:d}'.format(cohortcount))    print('Cohort mean mark = {0:.2f}'.format(cohortmean/cohortcount))    print('Mean credits taken = {0:.2f}  Mean credits passed = {1:.2f}'.format(cohortcredittakenmean/cohortcount, cohortcreditpassedmean/cohortcount))    print('First=',numberfirsts,' 2:1=',numberupper2,' 2:2=',numberlower2, ' Sum honours=',numberfirsts+numberlower2+numberupper2)    print('Thirds (BSc)=',numberthird,' ordinary (BSc)=',numberordinary)    print('Borderline=',numberborderline,' Number algorithmA=',numberPApromote,' Number algorithmB=',numberPBpromote)    print('Fails=',numberfail,' Sum all=',numberfirsts+numberlower2+numberupper2+numberthird+numberordinary+numberfail)# print to griddel df['PSI']#for col in dfallstudents.columns:    #print(col)# default sheet namesheet_name = 'PyAsssess2021.py'# set columns before writing out# final yearif(classyear==4):    if (studtype == 1):        columns=["Emplid",                "Name",                "Plan",                "Unit 1",                "Unit 2",                "Unit 3",                "Unit 4",                "Unit 5",                "Unit 6",                "Unit 7",                "Unit 8",                "Unit 9",                "Unit 10",                "Unit 11",                "Unit 12",                "Credits Taken",                "Credits Passed",                "Phys 1",                "Phys 2",                "Phys 3",                "Final Year Mark",                "Overall Mark",                "Deg Class",                "Courses Excluded"]                #"Courses Included",                #"Credits Excluded"]    else:        columns=["Name",                "Plan",                "Unit 1",                "Unit 2",                "Unit 3",                "Unit 4",                "Unit 5",                "Unit 6",                "Unit 7",                "Unit 8",                "Unit 9",                "Unit 10",                "Unit 11",                "Unit 12",                "Credits Taken",                "Credits Passed",                "Phys 1",                "Phys 2",                "Phys 3",                "Maths 1",                "Maths 2",                "Maths 3",                "Year 3 Mark",                "Final Year O/M/P",                "Overall O/M/P",                "Deg Class",                "Courses Excluded"]                #"Courses Included",                #"Credits Excluded"]    # final yearif(classyear==32):    if (studtype == 1):        columns=["Name",                "Plan",                "Unit 1",                "Unit 2",                "Unit 3",                "Unit 4",                "Unit 5",                "Unit 6",                "Unit 7",                "Unit 8",                "Unit 9",                "Unit 10",                "Unit 11",                "Unit 12",                "Credits Taken",                "Credits Passed",                "Phys 1",                "Phys 2",                "Final Year Mark",                "Overall Mark",                "Deg Class",                "Courses Excluded"]                #"Project Mark",                #"Borderline",                #"Courses Included",                #"Credits at First",                #"Credits at Upper 2",                #"Credits to Lower 2"]    else:        columns=["Emplid",                "Name",                "Plan",                "Unit 1",                "Unit 2",                "Unit 3",                "Unit 4",                "Unit 5",                "Unit 6",                "Unit 7",                "Unit 8",                "Unit 9",                "Unit 10",                "Unit 11",                "Unit 12",                "Unit 13",                "Unit 14",                "Unit 15",                "Unit 16",                "Credits Taken",                "Credits Passed",                "Phys 1",                "Phys 2",                "Maths 1",                "Maths 2",                "Final Year O/M/P",                "Overall O/M/P",                "Deg Class",                "Courses Excluded"]                #"Courses Included",                #"Courses Excluded",                #"Credits Excluded",                #"Credits at First",                #"Credits at Upper 2",                #"Credits to Lower 2"]        # 1st to secondif (classyear == 1):    if (studtype == 1):        columns=["Emplid",                "Name",                "Plan",                "Unit 1",                "Unit 2",                "Unit 3",                "Unit 4",                "Unit 5",                "Unit 6",                "Unit 7",                "Unit 8",                "Unit 9",                "Unit 10",                "Unit 11",                "Unit 12",                "Unit 13",                "Unit 14",                "Unit 15",                "Unit 16",                "Unit 17",                "Unit 18",                "Credits Taken",                "Credits Passed",                "Final Year Mark",                "Courses Excluded"]                # "Credits Excluded"]    else:        columns=["Emplid",                "Name",                "Plan",                "Unit 1",                "Unit 2",                "Unit 3",                "Unit 4",                "Unit 5",                "Unit 6",                "Unit 7",                "Unit 8",                "Unit 9",                "Unit 10",                "Unit 11",                "Unit 12",                "Unit 13",                "Unit 14",                "Unit 15",                "Unit 16",                "Unit 17",                "Unit 18",                "Credits Taken",                "Credits Passed",                "Final Year Maths Mark",                "Final Year Physics Mark",                "Final Year Mark",                "Courses Excluded"]                #"Credits Excluded"]# 2nd to 3rd progressionif (classyear == 2):    if (studtype == 1):        columns=["Emplid",                "Name",                "Plan",                "Unit 1",                "Unit 2",                "Unit 3",                "Unit 4",                "Unit 5",                "Unit 6",                "Unit 7",                "Unit 8",                "Unit 9",                "Unit 10",                "Unit 11",                "Unit 12",                "Unit 13",                "Unit 14",                "Unit 15",                "Unit 16",                "Credits Taken",                "Credits Passed",                "Final Year Mark",                "Fail",                "Lab/Proj Fail",                "Progress",                "Resits Triggered",                "Mark Under 30",                "Referrals Core",                "Referrals Option",                "Deferrals Core",                "Deferrals Option",                "Courses Included",                "Courses Excluded"]                # "Credits Excluded"]    else:        columns=["Emplid",                "Name",                "Plan",                "Unit 1",                "Unit 2",                "Unit 3",                "Unit 4",                "Unit 5",                "Unit 6",                "Unit 7",                "Unit 8",                "Unit 9",                "Unit 10",                "Unit 11",                "Unit 12",                "Unit 13",                "Unit 14",                "Unit 15",                "Unit 16",                "Credits Taken",                "Credits Passed",                'Maths Credits Taken',                'Maths Credits Passed',                "Final Year Mark",                "Final Year Maths Mark",                "Final Year Physics Mark",                "Fail",                "Lab/Proj Fail",                "Progress",                "Resits Triggered",                "Mark Under 30",                "Referrals Core",                "Referrals Option",                "Deferrals Core",                "Deferrals Option",                "Courses Included",                "Courses Excluded"]                #"Credits Excluded"]# 2nd to 3rd progressionif (classyear == 31):    if (studtype == 1):        columns=["Emplid",            "Name",            "Plan",            "Unit 1",            "Unit 2",            "Unit 3",            "Unit 4",            "Unit 5",            "Unit 6",            "Unit 7",            "Unit 8",            "Unit 9",            "Unit 10",            "Unit 11",            "Unit 12",            "Unit 13",            "Unit 14",            "Unit 15",            "Unit 16",            "Credits Taken",            "Credits Passed",            "Phys 1",            "Phys 2",            "Final Year Mark",            "Overall Mark",            "Courses Excluded",            "Progress"]            #"Courses Included",            #"Credits Excluded"]    else:        columns=["Emplid",                "Name",                "Plan",                "Unit 1",                "Unit 2",                "Unit 3",                "Unit 4",                "Unit 5",                "Unit 6",                "Unit 7",                "Unit 8",                "Unit 9",                "Unit 10",                "Unit 11",                "Unit 12",                "Unit 13",                "Unit 14",                "Unit 15",                "Unit 16",                "Credits Taken",                "Credits Passed",                "Phys 1",                "Phys 2",                "Final Year Physics Mark",                "Maths 1",                "Maths 2",                "Final Year Maths Mark",                "Overall Physics Mark",                "Overall Maths Mark",                "Overall Mark",                "Courses Excluded",                "Progress"]# output to Excel spreadsheettry:    writer = pd.ExcelWriter(outfilename, engine='xlsxwriter')except:    print('\nERROR writing out file. Please check directory...\n')    sys.exit(1)    dfallstudents.to_excel(writer,index=False,sheet_name=sheet_name,columns=columns)# Change column width/formatting before finally writing outworksheet = writer.sheets[sheet_name]i = 0for column_str in columns:    col_idx = i  # dfallstudents.columns.get_loc(column_str)    if (column_str == 'Emplid'): col_width=8    elif (column_str == 'Name'): col_width=15    elif (column_str == 'Plan'): col_width=20    elif (column_str.find('Unit') >= 0): col_width=9    elif (column_str.find('Credits') >= 0): col_width=9    elif (column_str.find('Final Year Physics Mark') >=0): col_width=18    elif (column_str.find('Final Year Maths Mark') >=0): col_width=16    elif (column_str.find('Overall Physics') >=0): col_width=15    elif (column_str.find('Overall Maths') >=0): col_width=13    elif (column_str.find('Phys') >= 0): col_width=6    elif (column_str.find('Maths') >= 0): col_width=7    elif (column_str.find('Year 3 Mark') >=0): col_width=8    elif (column_str.find('O/M/P') >=0): col_width=14    elif (column_str.find('Deg Class') >= 0): col_width=15    else: col_width=12  # deafult column width    writer.sheets[sheet_name].set_column(col_idx, col_idx, col_width)    i = i+1writer.save()    